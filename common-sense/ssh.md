
远程登陆linux服务器，一般用到的是`ssh user@server_ip`, 然后输入密码  
类似的还有文件传输， 使用`scp`命令

但是每次输入密码就很烦人，特别是如果与远程服务器之间还有跳板机存在的话，double 烦人

因此，有必要将经常会使用到的远程机器做一些处理，做到 **一键登陆** 和 **一键文件传输**

## Usage
**改造后**的使用方式如下
- 登陆远程主机

        ssh dev
    dev 是自行设置的远程主机别名，不再需要死记ip地址
- 向远程主机传输文件
    
        scp local_file dev:/tmp
    不再需要在跳板机上做中转

对比原来的使用方式，没有对比就没有伤害……

## 具体实现
实现原理也很简单
>就是在远程主机上永久存储自己的认证信息，下次登陆时不再重复认证

这里的认证信息，就是当前用户的ssh 密钥信息  
密钥分`公钥`和`私钥`，存储在远程机器上的是公钥信息

具体操作如下：  
- 生成本地ssh密钥
    - 运行命令 `ssh-keygen`
    - 全部使用默认选项即可，密钥会生成到当前用户目录下的`.ssh`文件夹下
- 将本地公钥存储到远程机器
    - 运行命令 `ssh-copy-id -i .ssh/id_rsa.pub user@remote_host`
    - 这里需要填写自己机器的信息，然后需要输入一次密码认证，  
        需要说明的是虽然传输的是公钥信息，但也会验证私钥，所以这俩文件须同时出现
    - 执行成功后，会在远程机器使用用户的`~/.ssh/`目录下生成一个文件`authorized_keys`，  
        存储当前认证的公钥信息
- 设置远程机器别名
    - 在当前用户目录的`.ssh`文件夹下，新建配置文件 `config`, 内容如下

            Host dev            # 别名
              HostName x.x.x.x  # 主机 ip
              User xxx          # 用户名 
              Port 22           # ssh 端口
        具体内容根据自己的实际信息填写，到这里就实现了`免密登陆`了，可以直接使用`ssh dev`
        代替原来的`ssh user@server_ip`, 传输文件也是如此

### 存在跳板机的配置
如果到服务器中间还需要跳板机，配置需要麻烦一点，但是原理不变，举例说明
- 本地机器称为 X
- 跳板机简称 Y
- 远程主机 Z

正常的流程是 `X -> Y -> Z`, 需要先从 X 登陆到 Y， 再从 Y 登陆到 Z,

> 所以按照之前说的原理， 那么 Y 上肯定需要存储 X 的认证信息， 同理，Z 上需要存储 Y 的认证信息  
改造后流程为 `X -> Z`, 因此 Z 上也需要存储 X 的密钥信息

明白了如上所说，操作就简单了，具体执行步骤如下
- 运行命令`ssh-copy-id` 将本地公钥（不存在先自行生成）同步到跳板机上存储
- 将本地的公钥和私钥都拷贝到跳板机上（使用scp或者其它方式）
- 登陆到跳板机，以相同的方式将拷贝过去的密钥和跳板机自身的密钥同步到远程主机上  
    出于安全考虑，存储成功后记得删除拷贝过去的本机密钥信息

- 配置本地的 `config`文件，示例如下
       
        # example
        Host dev
          HostName 30.23.x.x
          User sora
          Port 22

        Host jump   # 跳板机别名
          HostName 30.4.x.x
          User sora
          Port 22

        Host remote # 远程主机别名
          HostName 100.x.x.x
          User sora
          Port 22
          ProxyCommand ssh -q -W %h:%p jump  # 使用跳板机

    将具体的内容听换成自己的信息，保存即可

?> 如果存在两层及以上的跳板机，也是相同的处理方式

假设此处流程为`A -> B -> C -> D`  
首先，每一级都要存储前一级的认证信息，没有疑问  

然后`A -> D`用到的是跳板机 `C`, 所以先要处理`A -> C`, 这里就和前面的例子一样了，只有一层跳板机

C上也要存A的认证信息，同理，D 上 也要存 A的信息

逐级执行 `ssh-copy-id -i`命令， 再在本机编写`config`文件，即可实现一键登陆了




